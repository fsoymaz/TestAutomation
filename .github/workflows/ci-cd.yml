name: CI/CD Pipeline

on:
  push:
    branches:
      - test
  pull_request:
    branches:
      - test

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      checks: write
      statuses: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore

      - name: Run tests
        id: test
        run: dotnet test --verbosity normal --logger "trx;LogFileName=test-results.trx" --logger "console;verbosity=detailed"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: "**/test-results.trx"
          retention-days: 30

      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: "**/test-results.trx"
          check_name: "Unit Test Results"
          comment_mode: always
          report_individual_runs: true
          fail_on: "test failures"

      - name: Merge to main on success
        if: steps.test.outcome == 'success' && github.ref == 'refs/heads/test' && github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main:main
          git checkout main
          git merge test --no-edit
          git push origin main

      - name: Create issue on test failure
        if: steps.test.outcome == 'failure' && github.ref == 'refs/heads/test' && github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const { execSync } = require('child_process');

            let testLog = 'Test execution failed. Check the workflow logs for details.';

            try {
              // Find test results file
              const findResult = execSync('find . -name "test-results.trx" -type f', { encoding: 'utf8' }).trim();
              if (findResult) {
                const testResultsPath = findResult.split('\n')[0];
                const testResults = fs.readFileSync(testResultsPath, 'utf8');
                // Extract failure information from TRX file (simplified)
                const failureMatch = testResults.match(/<Message><!\[CDATA\[(.*?)\]\]><\/Message>/s);
                if (failureMatch) {
                  testLog = failureMatch[1].substring(0, 5000);
                } else {
                  testLog = testResults.substring(0, 5000);
                }
              }
            } catch (e) {
              console.log('Could not read test results file:', e.message);
            }

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Test Failure on test branch`,
              body: `## Test Execution Failed\n\n**Branch:** ${context.ref}\n**Commit:** ${context.sha.substring(0, 7)}\n**Author:** ${context.actor}\n**Workflow Run:** [View Details](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n### Test Results:\n\`\`\`\n${testLog}\n\`\`\`\n\nPlease check the workflow run for detailed logs and fix the failing tests.`,
              labels: ['bug', 'test-failure', 'automated']
            });

            console.log(`Created issue #${issue.data.number} for test failure`);
